name: Build and Deploy to Steam

on:
  push:
    branches: [ "next-release", "antigravity" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    env:
      DirectXSDKPath: DirectXSDK2010
      SolutionPath: ..\VS2022\Allegiance.sln
      SecurityRepoPath: AllegianceSecurity
      # Configuration matching the batch file (Batch uses Release for Tools, FZRetail for Game)
      BuildPlatform: Any CPU
      BuildConfiguration: FZRetail
      BUILD_DIR: "" # Initialized here to satisfy the linter

    steps:

    - name: Setup SteamCMD
      uses: CyberAndrii/setup-steamcmd@v1

    - name: Checkout Allegiance
      uses: actions/checkout@v4
      with:
        path: Allegiance

    - name: Initiate Steam Guard Request
      shell: bash
      # Batch provides: +login ZapHopBuilder ... +run_app_build_http ...
      # We need to ensure the VDF file path is correct. 
      # Batch: %LOCALDIR%\scripts\app_build_700480.vdf -> AllegianceSecurity\SteamContentBuilder\scripts\app_build_700480.vdf
      env:
        STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
        STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
      run: |
        c:/hostedtoolcache/windows/steamcmd/latest/i386/steamcmd +login $STEAM_USERNAME $STEAM_PASSWORD +quit || true

    - name: Get Steam Guard Code
      shell: pwsh
      env:
        STEAM_GUARD_MAILBOX: ${{ secrets.STEAM_GUARD_MAILBOX }}
      run: |
        $code = .\Allegiance\.github\scripts\get_steam_guard_code.ps1 -Mailbox $env:STEAM_GUARD_MAILBOX
        echo "STEAM_GUARD_CODE=$code" >> $env:GITHUB_ENV
        Write-Host "Steam Guard code captured: $code"

    - name: Login With Steam Guard Code
      shell: bash
      # Batch provides: +login ZapHopBuilder ... +run_app_build_http ...
      # We need to ensure the VDF file path is correct. 
      # Batch: %LOCALDIR%\scripts\app_build_700480.vdf -> AllegianceSecurity\SteamContentBuilder\scripts\app_build_700480.vdf
      env:
        STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
        STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
        STEAM_CONFIG_VDF: ${{ secrets.STEAM_CONFIG_VDF }}
      run: |
        c:/hostedtoolcache/windows/steamcmd/latest/i386/steamcmd +set_steam_guard_code $STEAM_GUARD_CODE +login $STEAM_USERNAME $STEAM_PASSWORD +quit

    - name: Checkout Allegiance
      uses: actions/checkout@v4
      with:
        path: Allegiance

    - name: Checkout AllegianceSecurity
      uses: actions/checkout@v4
      with:
        repository: BackTrak/AllegianceSecurity
        path: AllegianceSecurity
        token: ${{ secrets.ALLEGIANCE_SECURITY_PAT }}

    - name: Checkout DirectX SDK
      uses: actions/checkout@v4
      with:
        path: ${{ env.DirectXSDKPath }}
        repository: ReactiioN1337/DirectX-SDK

    - name: Checkout Artwork
      uses: actions/checkout@v4
      with:
        repository: FreeAllegiance/Artwork
        path: Artwork
        ref: next-release

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Download and Install DirectX SDK
      shell: powershell
      run: |
        # $Url = "https://download.microsoft.com/download/A/E/7/AE743F1F-632B-4809-87A9-AA1BB3458E31/DXSDK_Jun10.exe"
        # $Installer = "DXSDK_Jun10.exe"
        # Invoke-WebRequest -Uri $Url -OutFile $Installer
        # Start-Process -FilePath $Installer -ArgumentList "/U", "/O", "/F", "/S" -Wait
        
        # Manually set DXSDK_DIR
        # echo "DXSDK_DIR=C:\Program Files (x86)\Microsoft DirectX SDK (June 2010)\" >> $env:GITHUB_ENV

        # Set the DXSDK_DIR environment to point to the source path.
        $CurrentDir = Get-Location
        echo "BUILD_DIR=$CurrentDir" >> $env:GITHUB_ENV
        echo "DXSDK_DIR=$CurrentDir\${{ env.DirectXSDKPath }}" >> $env:GITHUB_ENV

        echo DirectX SDK Path: $CurrentDir\${{ env.DirectXSDKPath }}

    - name: Restore NuGet packages for Allegiance
      run: |
        pushd Allegiance\src
        nuget restore ${{ env.SolutionPath }}
        popd

    - name: Restore NuGet packages for AllegianceSecurity
      run: nuget restore ${{ env.SecurityRepoPath }}\AllegianceSecurity.sln

    - name: Build AllegianceSecurity Tools
      run: |
        msbuild ${{ env.SecurityRepoPath }}\AllegianceSecurity.sln /p:Configuration=Release /p:Platform="Any CPU" /t:AllegianceBuildTool

    - name: Generate Artwork Hashes
      # Batch: AllegianceBuildTool.exe -generateArtworkHashes "C:\Source\git\Artwork" ...
      # Note: Artwork folder is referenced. Assuming it is in the root or explicitly checked out. 
      # The batch file had "C:\Source\git\Artwork". We might need to check out the Artwork repo too if it's separate.
      # For now, assuming it might be missing or part of the main repo. 
      # Warning on this step if Artwork repo is needed.
      continue-on-error: true 
      run: |
        ${{ env.SecurityRepoPath }}\AllegianceBuildTool\bin\Release\AllegianceBuildTool.exe -generateArtworkHashes "Allegiance\artwork" "${{ env.SecurityRepoPath }}\AllegianceSecurity\FileHashTable.cpp"

    - name: Update Build Number
      run: |
        ${{ env.SecurityRepoPath }}\AllegianceBuildTool\bin\Release\AllegianceBuildTool.exe -updateBuildNumber "Allegiance\src\Inc\SlmVer.h"

    - name: Build AllegianceSecurity Tools
      run: |
        msbuild ${{ env.SecurityRepoPath }}\AllegianceSecurity.sln /p:Configuration=Release /p:Platform="Any CPU" /t:AllegianceBuildTool
        msbuild ${{ env.SecurityRepoPath }}\AllegianceSecurity.sln /p:Configuration=Release /p:Platform=x86 /t:AllegianceSecurity '/p:IncludePath="${{ github.workspace }}\Allegiance\src\zlib;${{ github.workspace }}\${{ env.SecurityRepoPath }}\lib\steam;"'
        msbuild ${{ env.SecurityRepoPath }}\AllegianceSecurity.sln /p:Configuration=Debug /p:Platform=x86 /t:AllegianceSecurity '/p:IncludePath="${{ github.workspace }}\Allegiance\src\zlib;${{ github.workspace }}\${{ env.SecurityRepoPath }}\lib\steam;"'

    - name: Copy Security Libs to Allegiance
      # Mirroring: xcopy ... C:\Source\git\Allegiance\src\Lib\AllegianceSecurity\ /Y
      run: |
        xcopy "${{ env.SecurityRepoPath }}\Release\AllegianceSecurity.lib" "Allegiance\src\Lib\AllegianceSecurity\" /Y
        xcopy "${{ env.SecurityRepoPath }}\Debug\AllegianceSecurityd.lib" "Allegiance\src\Lib\AllegianceSecurity\" /Y

    - name: Setup MSVC Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86

    
    - name: Build Allegiance (FZRetail)
      shell: cmd
      run: |
        pushd Allegiance\src
        msbuild "..\VS2022\Allegiance.sln" /p:Configuration="FZRetail" /p:Platform="Any CPU" /p:IncludePath="D:\a\Allegiance\Allegiance\DirectXSDK2010\Include;..\src\lib\lua\include;..\src\lib\sol\include;$(IncludePath)" /p:LibraryPath="D:\a\Allegiance\Allegiance\DirectXSDK2010\Lib\x86;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\um\x86;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\ucrt\x86;C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.44.35207\lib\x86;C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.44.35207\atlmfc\lib\x86;..\src\lib\lua;..\src\lib\sol;$(LibraryPath)" /p:AutoBuild=true /t:Allegiance
        popd

    # Staging - Mirroring batch file xcopy commands
    - name: Stage Build Artifacts
      run: |
        mkdir ${{ env.SecurityRepoPath }}\SteamContentBuilder\Staging
        $StagingDir = "${{ env.SecurityRepoPath }}\SteamContentBuilder\Staging"
        
        # Security Tools
        xcopy "${{ env.SecurityRepoPath }}\AllegianceBuildTool\bin\Release\*.exe" "$StagingDir\" /s /d /Y
        xcopy "${{ env.SecurityRepoPath }}\AllegianceBuildTool\bin\Release\*.dll" "$StagingDir\" /s /d /Y

        # Game Binaries (FZRetail / Win32 aka x86)
        # Note: Batch used 'objsv143\FZRetail'. MSBuild output path might differ on clean env, usually matches sln.
        # Assuming defaults based on VS2022/Allegiance.sln
        
        $ObjDir = "Allegiance\objsv143\FZRetail"
        
        xcopy "$ObjDir\Wintrek\*.dll" "$StagingDir\" /s /d /Y
        xcopy "$ObjDir\Wintrek\*.pdb" "$StagingDir\" /s /d /Y
        
        xcopy "$ObjDir\AllSrvUI\AllSrvUI.exe" "$StagingDir\" /s /d /Y
        xcopy "$ObjDir\AllSrvUI\AllSrvUI.pdb" "$StagingDir\" /s /d /Y
        
        xcopy "$ObjDir\FedSrv\AllSrv.exe" "$StagingDir\" /s /d /Y
        xcopy "$ObjDir\FedSrv\AllSrv.pdb" "$StagingDir\" /s /d /Y
        
        xcopy "$ObjDir\AGC\AGC.dll" "$StagingDir\" /s /d /Y
        xcopy "$ObjDir\AGC\AGC.pdb" "$StagingDir\" /s /d /Y
        
        xcopy "$ObjDir\Wintrek\Allegiance.exe" "$StagingDir\Allegiance.exe*" /Y /d
        xcopy "$ObjDir\Wintrek\Allegiance.pdb" "$StagingDir\Allegiance.pdb*" /Y /d

    - name: Deploy to Steam
      shell: bash
      # If the account times out, you can update the steam guard code in the action secrets (see repo settings),
      # then add this to the steamcmd command: +set_steam_guard_code $env:STEAM_GUARD_CODE
      env:
        STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
        STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
      run: |
        pwd
        cd ${{ env.SecurityRepoPath }}/SteamContentBuilder
        ls -la ./scripts
        ls -la ./Staging
        export scriptsDir=$(cygpath -u "$GITHUB_WORKSPACE/${{ env.SecurityRepoPath }}/SteamContentBuilder/scripts")
        ls -la $scriptsDir
        c:/hostedtoolcache/windows/steamcmd/latest/i386/steamcmd +set_steam_guard_code $STEAM_GUARD_CODE +login $STEAM_USERNAME $STEAM_PASSWORD +run_app_build_http -desc "GitHub Action Build: $GITHUB_SHA" "$scriptsDir/app_next-release_build_700480.vdf" +quit
    
    - name: Update Build Hash
      env:
        DRM_UPLOAD_KEY: ${{ secrets.DRM_UPLOAD_KEY }}
      run: |
        $StagingDir = "${{ env.SecurityRepoPath }}\SteamContentBuilder\Staging"
        ${{ env.SecurityRepoPath }}\AllegianceBuildTool\bin\Release\AllegianceBuildTool.exe -generateFileChecksumAndUpload "https://allegiance.zaphop.com/api/drm" $DRM_UPLOAD_KEY "$StagingDir\Allegiance.exe"